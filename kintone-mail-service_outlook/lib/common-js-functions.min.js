/**!
 * JSCustomize on kintone
 * Common functions
 * Copyright (c) 2017 Cybozu
 *
 * Licensed under the MIT License
 */
!function(){"use strict"
window.kintoneCustomize={setting:{element:{style:{spinner:'.kintoneCustomizeloading{position: fixed; width: 100%; height:100%;top: 0; left:0; z-index:1000; background:rgba(204, 204, 204, 0.3)}.kintoneCustomizeloading:before{position: fixed; top: calc(50% - 25px);content: "";left: calc(50% - 25px);border:8px solid #f3f3f3;border-radius:50%;border-top:8px solid #3498db;width:50px;height:50px;-webkit-animation:spin .8s linear infinite; animation:spin .8s linear infinite}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}'}},apiUrl:{app:"/k/v1/app",form:"/k/v1/app/form/fields",layout:"/k/v1/app/form/layout",record:"/k/v1/record",records:"/k/v1/records",user:"/v1/users",userGroup:"/v1/user/groups",userOrganization:"/v1/user/organizations",file:"/k/v1/file.json?fileKey=",status:"/k/v1/record/status",statusApp:"/k/v1/app/status"},fieldSupport:{makePrefix:["__ID__","SINGLE_LINE_TEXT","DROP_DOWN"]},message:{requestNotAvailable:"Error occurred when retrieving data, please try again!"}},data:{user:{code:kintone.getLoginUser().code,group:null}},preload:function(){this.ui.addStyleToHead(this.setting.element.style.spinner)},fnc:{app:{}},kintoneListenEvent:function(e,t,r){kintone.events.on(e,function(e){return r&&r[t]?r[t](e):t(e)})},disableFields:function(e,t){try{return this.setting.app[e].fieldCode.disabled.length>0&&this.setting.app[e].fieldCode.disabled.forEach(function(r){t[this.setting.app[e].fieldCode[r]].disabled=!0},this),t}catch(e){this.showError(e)}},record:function(e){var t=this
return{recordData:e,getStringByPrefix:function(e){var r=e
for(var n in this.recordData)this.recordData.hasOwnProperty(n)&&(r=-1===t.setting.fieldSupport.makePrefix.indexOf(this.recordData[n].type)?r.replace("{{"+n+"}}","_"+n.toUpperCase()+"_"):r.replace("{{"+n+"}}",this.recordData[n].value))
return r=t.getStringByPrefixDate(r,new Date)},getValueByType:function(e){var t=e.toUpperCase()
for(var r in this.recordData)if(this.recordData.hasOwnProperty(r)&&this.recordData[r].type===t)return this.recordData[r].value
return null},checkFieldExists:function(e){var t={status:!0,invalidField:""}
return"string"==typeof e?(t.status=this.recordData.hasOwnProperty(e),t.invalidField=e):e.constructor===Array?e.forEach(function(e){this.recordData.hasOwnProperty(e)||(t.status=!1,t.invalidField+=","+e)},this):t.status=!1,t}}},records:function(e){return{recordsData:e,getIds:function(e){var t=[]
return this.recordsData.forEach(function(e){t.push(parseInt(e.$id.value,10))},this),t}}},getUserGroup:function(e){var t=this
return this.apiRequest(t.setting.apiUrl.userGroup,"GET",{code:e}).then(function(e){var t=[]
return e.groups.forEach(function(e){t.push(e.code)}),t})},apiRequestWithProxy:function(e,t,r,n){var i=this,o={"X-Cybozu-API-Token":n}
"GET"!==t&&"DELETE"!==t&&(o["Content-Type"]="application/json")
var a=this.setting.apiUrl[e]||"/v1/apis",s="GET"!==t&&"DELETE"!==t?kintone.api.url(a):kintone.api.urlForGet(a,r)
return new kintone.Promise(function(e,n){kintone.proxy(s,t,o,r,function(t){var r=window.JSON.parse(t)
"string"==typeof r.code?n(r):e(r)},function(e){n(e)})}).then({},function(e){return i.showError(e),!1})},apiRequest:function(e,t,r){var n=this,i=this.setting.apiUrl[e]||"/k/v1/apis"
return new kintone.Promise(function(e,n){kintone.api(kintone.api.url(i,!0),t,r,function(t){e(t)},function(e){n(e)})}).then({},function(e){return n.showError(e),!1})},getFile:function(e,t){var r=this
return new kintone.Promise(function(r,n){var i=new XMLHttpRequest
i.open("GET",e,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.responseType="arraybuffer",i.onload=function(){var e=new window.Uint8Array(this.response),n=new Blob([e],{type:t+";charset=utf-8;"})
r(n)},i.onerror=function(e){n(e)},i.send()}).then({},function(e){return r.showError(e),!1})},formRequest:function(e,t,r,n){return new kintone.Promise(function(i,o){var a=new XMLHttpRequest
a.open(t,e),void 0!==n&&n.length>0&&n.forEach(function(e){e.key&&e.value&&a.setRequestHeader(e.key,e.value)}),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.onload=function(){200===a.status?i(this):o(a)},a.send(r)})},getTimeUser:function(){var e=this
return this.getTimeServer().then(function(t){return window.moment?window.moment.tz(t,kintone.getLoginUser().timezone).format("YYYY-MM-DD"):e.getDateString(new Date(t))})},getTimeServer:function(){return kintone.proxy(kintone.api.urlForGet("/v1/app",{}),"GET",{},{}).then(function(e){return e[2].Date})},getStringByPrefixDate:function(e,t){var r=e,n=t.getFullYear().toString(),i=(t.getMonth()+1).toString(),o=t.getDate().toString(),a=t.getHours().toString(),s=t.getMinutes().toString()
return r=r.replace(/{{yyyy}}|{{YYYY}}/g,n),r=r.replace(/{{yy}}|{{YY}}/g,n.substring(2)),r=r.replace(/{{mm}}|{{MM}}/g,i[1]?i:"0"+i[0]),r=r.replace(/{{dd}}|{{DD}}/g,o[1]?o:"0"+o[0]),r=r.replace(/{{hh}}|{{HH}}/g,a[1]?a:"0"+a[0]),r=r.replace(/{{ii}}|{{II}}/g,s[1]?s:"0"+s[0])},getDateStringByFormat:function(e,t){void 0===t&&(t=new Date)
var r=e,n=t.getFullYear().toString(),i=(t.getMonth()+1).toString(),o=t.getDate().toString(),a=t.getHours().toString(),s=t.getMinutes().toString()
return r=r.replace(/yyyy|YYYY/g,n),r=r.replace(/yy|YY/g,n.substring(2)),r=r.replace(/mm|MM/g,i[1]?i:"0"+i[0]),r=r.replace(/dd|DD/g,o[1]?o:"0"+o[0]),r=r.replace(/hh|HH/g,a[1]?a:"0"+a[0]),r=r.replace(/ii|II/g,s[1]?s:"0"+s[0])},getDateString:function(e){if(void 0===e)return""
if(isNaN(e.getUTCFullYear())||isNaN(e.getUTCMonth())||isNaN(e.getUTCDate()))return""
var t=e.getUTCFullYear()+"-"
return t+=e.getUTCMonth()>8?e.getUTCMonth()+1:"0"+(e.getUTCMonth()+1),t+="-"+e.getUTCDate()},filePath:function(e){return{filePath:e,getExtention:function(){return this.filePath.toString().split(".").reverse()[0]},getBasename:function(e){var t=void 0===e?"/":e
return this.filePath.toString().split(t).reverse()[0]},getFileName:function(){return this.getBasename().replace("."+this.getExtention(),"")}}},ui:{element:function(e){var t=e
return{append:function(e){try{return e.constructor===Array?(e.forEach(function(e){t.appendChild(e)}),this):(t.appendChild(e),this)}catch(e){return this}},appendTo:function(e){try{return e.appendChild(t),t=e,this}catch(e){return this}},prepend:function(e){try{return e.constructor===Array?(e.forEach(function(e){t.insertBefore(e,t.firstChild)}),this):(t.insertBefore(e,t.firstChild),this)}catch(e){return this}}}},elements:function(e){var t=[]
if("string"==typeof e){var r=document.querySelectorAll(e)
t=Array.prototype.slice.call(r)}else t.push(e)
return{elArr:t,on:function(e,t){return this.each(function(r){r.addEventListener(e,t)}),this},each:function(e){this.elArr.forEach(function(t,r){e(t,r)},this)},data:function(e,t){if(void 0===t)return this.elArr[0].getAttribute("data-"+e)
try{this.elArr.forEach(function(r){this.attr("data-"+e,t)},this)}catch(e){return!1}return this},attr:function(e,t){return 0===this.elArr.length?void 0!==t?this:null:void 0!==t?(this.elArr.forEach(function(r){r.setAttribute(e,t)},this),this):this.elArr[0].getAttribute(e)},removeAttr:function(e){this.attr()},val:function(e){return 0===this.elArr.length?void 0!==e?this:null:void 0!==e?(this.elArr.forEach(function(t){t.value=e},this),this):this.elArr[0].value},html:function(e){return 0===this.elArr.length?void 0!==e?this:null:void 0!==e?(this.elArr.forEach(function(t){t.innerHTML=e},this),this):this.elArr[0].innerHTML},focus:function(){0!==this.elArr.length&&this.elArr[0].focus()},remove:function(e){0!==this.elArr.length&&this.elArr.forEach(function(e){try{e.parentNode.removeChild(e)}catch(e){}},this)},trigger:function(e){0!==this.elArr.length&&this.elArr.forEach(function(t){t.dispatchEvent(function(){if("function"==typeof Event)return new Event(e,{bubbles:!0,cancelable:!0})
var t=document.createEvent("Event")
return t.initEvent(e,!0,!0),t}())},this)},addClass:function(e){try{return this.elArr.forEach(function(t){var r=t.className.split(" ");-1===r.indexOf(e)&&(r.push(e),t.className=r.join(" ").trim())},this),this}catch(e){return this}},removeClass:function(e){try{return this.hasClass(e)?(this.elArr.forEach(function(t){var r=t.className.split(" ")
r.splice(r.indexOf(e),1),t.className=r.join(" ")},this),this):this}catch(e){return this}},hasClass:function(e){if(void 0===e)return!1
try{return-1!==this.elArr[0].className.split(" ").indexOf(e)}catch(e){return!1}},append:function(e){try{return this.elArr.forEach(function(t){if(e.constructor===Array)return e.forEach(function(e){t.appendChild(e.elArr?e.elArr[0]||null:e)}),this
t.appendChild(e.elArr?e.elArr[0]||null:e)},this),this}catch(e){return this}},appendTo:function(e){try{return this.elArr.forEach(function(t){if(e.constructor===Array)return e.forEach(function(e){(e.elArr?e.elArr[0]||null:e).appendChild(t)}),this;(e.elArr?e.elArr[0]||null:e).appendChild(t)},this),this}catch(e){return window.console.error(e),this}},prepend:function(e){try{return this.elArr.forEach(function(t){if(e.constructor===Array)return e.forEach(function(e){t.insertBefore(e.elArr?e.elArr[0]||null:e,t.firstChild)}),this
t.insertBefore(e.elArr?e.elArr[0]||null:e,t.firstChild)}),this}catch(e){return this}}}},createButton:function(e,t){if(document.getElementById(e.id))return null
var r=document.createElement("button")
r.id=e.id||"",r.className=e.class||""
var n=t?t[e.text]||e.text||"":e.text||""
return r.innerHTML=n,r.style.cssText=e.style||"",r},addStyleToHead:function(e){var t=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style")
r.type="text/css",r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e)),t.appendChild(r)},loading:{loading:null,show:function(e){var t="kintoneCustomizeloading",r=document.getElementById(t),n=document.createElement("div")
if(!this.loading||!r){if(!1===e)return void(r&&r.parentNode.removeChild(r))
n.className=t,n.id=t,document.body.appendChild(n),this.loading=!0}},hide:function(){this.loading=!1,this.show(!1)}},createMessageTemplate:function(){var e=document.createElement("div"),t=document.createElement("div"),r=document.createElement("header"),n=document.createElement("ul"),i=document.createElement("span"),o=document.createElement("span")
return o.className="close",o.addEventListener("click",function(){e.className="hidden"}),e.id="kintoneCustomizeMessage",e.className="hidden",this.element(r).append([i,o]),this.element(t).append([r,n]).appendTo(e),document.body.appendChild(e),e}},objectValueToArray:function(e){var t=[]
for(var r in e)e.hasOwnProperty(r)&&t.push(e[r])
return t},objectMerge:function(e,t){return Object.keys(t).forEach(function(r){e[r]=t[r]}),e},showError:function(e){try{var t=e.code?e:window.JSON.parse(e)
window.console.error(t.code+"\n"+t.message)}catch(t){window.console.error(e)}},alertMessage:function(e,t){var r="#kintoneCustomizeMessage",n=document.querySelector(r)
n||(n=this.ui.createMessageTemplate()),n.className=""
var i=document.querySelector(r+" header>span"),o=document.querySelector(r+" ul")
if(i.innerHTML="",o.innerHTML="",e.header)return i.innerHTML=e.header,void(e.messages&&(e.messages.length>0&&(document.querySelector(r+">div").style.width="auto"),e.messages.forEach(function(e){var t=document.createElement("li")
t.innerHTML=e,o.appendChild(t)})))
var a=document.createElement("li")
a.innerHTML=e,o.appendChild(a)}},window.kintoneCustomize.preload()}()
